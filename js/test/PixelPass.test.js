const {decode, generateQRCode, generateQRData, getCWT, decodeCWT} = require("../src");
const {expect} = require("expect");
const {ECC} = require("../src/types/ECC");

test("should return decoded data for given QR data", () => {
    const data = "NCFKVPV0QSIP600GP5L0";
    const expected = "hello";

    const actual = decode(data);
    expect(actual).toBe(expected);
});
test("should return decoded data for given QR data in cbor", () => {
    const data = "NCFHPE/Q6:96+963Y6:96P563H0 %2DH0";
    const expected = '{"temp":15}';

    const actual = decode(data);
    expect(actual).toBe(expected);
});
test("should throw error if given data is null or undefined for encoding", () => {
    expect(() => generateQRData(null)).toThrowError(
        "Cannot read properties of null (reading 'length')"
    );
    expect(() => generateQRData(undefined)).toThrowError(
        "Cannot read properties of undefined (reading 'length')"
    );
});
test("should throw error if given data is invalid for decoding", () => {
    expect(() => decode("NCFKVPV0QSIP600GP5L00")).toThrowError(
        "incorrect data check"
    );
});
test("should throw error if given data is null or undefined", () => {
    expect(() => decode(null)).toThrowError(
        "utf8StringArg is null or undefined."
    );
    expect(() => decode(undefined)).toThrowError(
        "utf8StringArg is null or undefined."
    );
});
test("should throw error if given data length is bad", () => {
    expect(() => decode("1")).toThrowError("utf8StringArg has incorrect length.");
    expect(() => decode("1234")).toThrowError(
        "utf8StringArg has incorrect length."
    );
});
test("should throw error if given data is invalid", () => {
    expect(() => decode("^1")).toThrowError("Invalid character at position 0.");
    expect(() => decode("1^")).toThrowError("Invalid character at position 1.");
    expect(() => decode("0123456789^")).toThrowError(
        "Invalid character at position 10."
    );
});
test("should return encoded QR data for data", () => {
    const expected = "NCFKVPV0QSIP600GP5L0";
    const data = "hello";

    const actual = generateQRData(data);
    expect(actual).toBe(expected);
});
test("should return encoded QR data for data with header", () => {
    const expected = "mockHeader://" + "NCFKVPV0QSIP600GP5L0";
    const data = "hello";

    const actual = generateQRData(data, "mockHeader://");
    expect(actual).toBe(expected);
});
test("should return base64 encoded QR for given data", async () => {
    const data = "hello";
    const expected =
        "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQ4AAAEOCAYAAAB4sfmlAAAAAklEQVR4AewaftIAAAUpSURBVO3BQY5bCw4EsCrB97+yJvvePH14YKdDsvtHAA4mAEcTgKMJwNEE4GgCcDQBOJoAHE0AjiYARxOAownA0QTgaAJwNAE4mgAcTQCOJgBHE4CjCcDRBOBoAnA0ATiaABxNAI4mAEcTgKMJwNEE4GgCcPTKh7QNP+1uPqFtntjdPNE2T+xunmgbftrdfMIE4GgCcDQBOJoAHE0AjiYARxOAownA0QTg6JUvt7v5DdrmndrmnXY3v8Hu5jdom282ATiaABxNAI4mAEcTgKMJwNEE4GgCcDQBOHrll2ibT9jdfMLu5p3a5p12N9+sbT5hd/MbTACOJgBHE4CjCcDRBOBoAnA0ATiaABxNAI5e4Vdrmyd2N+/UNk/sbvj7TACOJgBHE4CjCcDRBOBoAnA0ATiaABxNAI5e4a/UNu/UNk/sbmACcDQBOJoAHE0AjiYARxOAownA0QTgaAJw9Movsbv5l+xuPqFtntjdfLPdDf/dBOBoAnA0ATiaABxNAI4mAEcTgKMJwNEE4OiVL9c2/NQ2T+xunmibJ3Y3T7TNE7ubd2ob/v8mAEcTgKMJwNEE4GgCcDQBOJoAHE0AjiYAR90/wj+vbT5hd8PfZwJwNAE4mgAcTQCOJgBHE4CjCcDRBOBoAnD0yoe0zRO7myfa5ondzRNt88Tu5om2eWJ38812N0+0zTdrmyd2N+/UNk/sbr7ZBOBoAnA0ATiaABxNAI4mAEcTgKMJwNEE4Kj7Rz6gbd5pd/NE2zyxu/mEtnlid/NE2zyxu3mibf4lu5tPaJsndjefMAE4mgAcTQCOJgBHE4CjCcDRBOBoAnA0ATh65cvtbp5om09om09omyd2N0+0zSfsbp5om09oG36aABxNAI4mAEcTgKMJwNEE4GgCcDQBOJoAHHX/CD+0zTvtbp5omyd2N9+sbZ7Y3bxT27zT7oafJgBHE4CjCcDRBOBoAnA0ATiaABxNAI4mAEev/GPa5ondzTu1zTu1zRO7m3dqm99gd/PN2uaJ3c0nTACOJgBHE4CjCcDRBOBoAnA0ATiaABxNAI66f4S/Ttv8Brubd2qbd9rdPNE277S7+WYTgKMJwNEE4GgCcDQBOJoAHE0AjiYARxOAo+4f+YC24afdzSe0zRO7m09omyd2N+/UNk/sbp5om3fa3XzCBOBoAnA0ATiaABxNAI4mAEcTgKMJwNEE4OiVL7e7+Q3a5hPa5p3a5hN2N0+0zRO7myd2N/w0ATiaABxNAI4mAEcTgKMJwNEE4GgCcDQBOHrll2ibT9jdfELbPLG7eae24b/b3fwGE4CjCcDRBOBoAnA0ATiaABxNAI4mAEcTgKNX+Cvtbp5omyd2N++0u3mibZ5omyd2N+/UNk/sbp5omyd2N99sAnA0ATiaABxNAI4mAEcTgKMJwNEE4GgCcPQKf6W2eae2eae2eWJ380Tb/Aa7myfa5ondzSdMAI4mAEcTgKMJwNEE4GgCcDQBOJoAHE0Ajl75JXY3/5LdzSe0zRO7myfa5ondzTu1zSe0zW8wATiaABxNAI4mAEcTgKMJwNEE4GgCcDQBOHrly7UNP7XNJ+xu3ml380TbPLG7eWJ38wm7myfa5ptNAI4mAEcTgKMJwNEE4GgCcDQBOJoAHE0Ajrp/BOBgAnA0ATiaABxNAI4mAEcTgKMJwNEE4GgCcDQBOJoAHE0AjiYARxOAownA0QTgaAJwNAE4mgAcTQCOJgBHE4CjCcDRBOBoAnA0ATiaABxNAI4mAEf/A4+rCzKLi4oKAAAAAElFTkSuQmCC";

    const actual = await generateQRCode(data, ECC.M);
    expect(actual).toBe(expected);
});
test("should return base64 encoded QR for given data with header", async () => {
    const data = "hello";
    const header = "mockHeader://";
    const expected =
        "data:image/png;base64,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";

    const actual = await generateQRCode(data, ECC.M, header);
    expect(actual).toBe(expected);
});
test("should return CWT  for given data with map", async () => {
    const encKey = {
        k: Buffer.from(
            "403697de87af64611c1d32a05dab0fe1fcb715a86ab435f1ec99192d79569388",
            "hex"
        ),
        kid: "Symmetric256",
    };
    const alg = "HS256/64";
    const data = {name: "Jhon", id: "207", l_name: "Honay"};
    const map = {id: 1, name: 2, l_name: 3};
    const expected =
        "d18443a10104a1044c53796d6d657472696332353653a302644a686f6e01633230370365486f6e617948651effd05bc36f6c";

    const actual = await getCWT(data, map, encKey, alg);
    expect(actual).toBe(expected);
});
test("should return CWT  for given data with map for claim 169 semantics", async () => {
    const encKey = {
        k: Buffer.from(
            "403697de87af64611c1d32a05dab0fe1fcb715a86ab435f1ec99192d79569388",
            "hex"
        ),
        kid: "Symmetric256",
    };
    const alg = "HS256/64";

    const data = {
        id: "11110000324013",
        version: "1.0",
        language: "EN",
        fullName: "Peter M Jhon",
        firstName: "Peter",
        middleName: "M",
        lastName: "Jhon",
        dob: "19880102",
        gender: 1,
        address: "New City, METRO LINE, PA",
        email: "peter@example.com",
        phone: "+1 234-567",
        nationality: "US",
        maritalStatus: 2,
        guardian: "Jhon Honai",
        binaryImage:
            "03CBABDF83D068ACB5DE65B3CDF25E0036F2C546CB90378C587A076E7A759DFD27CA7872B6CDFF339AEAACA61A6023FD1D305A9B4F33CAA248CEDE38B67D7C915C59A51BB4E77D10077A625258873183F82D65F4C482503A5A01F41DEE612C3542E5370987815E592B8EA2020FD3BDDC747897DB10237EAD179E55B441BC6D8BAD07CE535129CF8D559445CC3A29D746FBF1174DE2E7C0F3439BE7DBEA4520CF88825AAE6B1F291A746AB8177C65B2A459DD19BD32C0C3070004B85C1D63034707CC690AB0BA023350C8337FC6894061EB8A714A8F22FE2365E7A904C72DEC9746ABEA1A3296ECACD1A40450794EDCD2B34844E7C19EB7FB1A4AF3B05C3B374BD2941603F72D3F9A62EAB9A2FDAEEEEC8EE6E350F8A1863C0A0AB1B4058D154559A1CD5133EFCF682ABC339960819C9427889D60380B635A7D21D017974BBA57798490F668ADD86DA58125D9C4C1202CA1308F7734E43E8F77CEB0AF968A8F8B88849F9B98B26620399470ED057E7931DED82876DCA896A30D0031A8CBD7B9EDFDF16C15C6853F4F8D9EEC09317C84EDAE4B349FE54D23D8EC7DC9BB9F69FD7B7B23383B64F22E25F",
        binaryImageFormat: 2,
        bestQualityFingers: [1, 2],
    };
    const map = {
        id: 1,
        version: 2,
        language: 3,
        fullName: 4,
        firstName: 5,
        middleName: 6,
        lastName: 7,
        dob: 8,
        gender: 9,
        address: 10,
        email: 11,
        phone: 12,
        nationality: 13,
        maritalStatus: 14,
        guardian: 15,
        binaryImage: 16,
        binaryImageFormat: 17,
        bestQualityFingers: 18,
    };

    const expected =
        "d18443a10104a1044c53796d6d65747269633235365903ebb2016e31313131303030303332343031330263312e300362454e046c5065746572204d204a686f6e0565506574657206614d07644a686f6e0868313938383031303209010a78184e657720436974792c204d4554524f204c494e452c2050410b717065746572406578616d706c652e636f6d0c6a2b31203233342d3536370d6255530e020f6a4a686f6e20486f6e61691079035130334342414244463833443036384143423544453635423343444632354530303336463243353436434239303337384335383741303736453741373539444644323743413738373242364344464633333941454141434136314136303233464431443330354139423446333343414132343843454445333842363744374339313543353941353142423445373744313030373741363235323538383733313833463832443635463443343832353033413541303146343144454536313243333534324535333730393837383135453539324238454132303230464433424444433734373839374442313032333745414431373945353542343431424336443842414430374345353335313239434638443535393434354343334132394437343646424631313734444532453743304633343339424537444245413435323043463838383235414145364231463239314137343641423831373743363542324134353944443139424433324330433330373030303442383543314436333033343730374343363930414230424130323333353043383333374643363839343036314542384137313441384632324645323336354537413930344337324445433937343641424541314133323936454341434431413430343530373934454443443242333438343445374331394542374642314134414633423035433342333734424432393431363033463732443346394136324541423941324644414545454543384545364533353046384131383633433041304142314234303538443135343535394131434435313333454643463638324142433333393936303831394339343237383839443630333830423633354137443231443031373937344242413537373938343930463636384144443836444135383132354439433443313230324341313330384637373334453433453846373743454230414639363841384638423838383439463942393842323636323033393934373045443035374537393331444544383238373644434138393641333044303033314138434244374239454446444631364331354336383533463446384439454543303933313743383445444145344233343946453534443233443845433744433942423946363946443742374232333338334236344632324532354611021282010248a8b933c56fa9d33d";

    const actual = await getCWT(data, map, encKey, alg);
    expect(actual).toBe(expected);
});
test("should return properly mapped JSON data for given cwt", async () => {
    const decKey = {
        k: Buffer.from(
            "403697de87af64611c1d32a05dab0fe1fcb715a86ab435f1ec99192d79569388",
            "hex"
        ),
        kid: "Symmetric256",
    };
    const expected = {name: "Jhon", id: "207", l_name: "Honay"};
    const map = {"1": "id", "2": "name", "3": "l_name"};
    const data = "d18443a10104a1044c53796d6d657472696332353653a302644a686f6e01633230370365486f6e617948651effd05bc36f6c";

    const actual = await decodeCWT(data, map, decKey);
    expect(actual).toStrictEqual(expected);
});
test("should return properly mapped JSON data for given cwt for claim 169 semantics", async () => {
    const decKey = {
        k: Buffer.from(
            "403697de87af64611c1d32a05dab0fe1fcb715a86ab435f1ec99192d79569388",
            "hex"
        ),
        kid: "Symmetric256",
    };

    const expected = {
        id: "11110000324013",
        version: "1.0",
        language: "EN",
        fullName: "Peter M Jhon",
        firstName: "Peter",
        middleName: "M",
        lastName: "Jhon",
        dob: "19880102",
        gender: 1,
        address: "New City, METRO LINE, PA",
        email: "peter@example.com",
        phone: "+1 234-567",
        nationality: "US",
        maritalStatus: 2,
        guardian: "Jhon Honai",
        binaryImage:
            "03CBABDF83D068ACB5DE65B3CDF25E0036F2C546CB90378C587A076E7A759DFD27CA7872B6CDFF339AEAACA61A6023FD1D305A9B4F33CAA248CEDE38B67D7C915C59A51BB4E77D10077A625258873183F82D65F4C482503A5A01F41DEE612C3542E5370987815E592B8EA2020FD3BDDC747897DB10237EAD179E55B441BC6D8BAD07CE535129CF8D559445CC3A29D746FBF1174DE2E7C0F3439BE7DBEA4520CF88825AAE6B1F291A746AB8177C65B2A459DD19BD32C0C3070004B85C1D63034707CC690AB0BA023350C8337FC6894061EB8A714A8F22FE2365E7A904C72DEC9746ABEA1A3296ECACD1A40450794EDCD2B34844E7C19EB7FB1A4AF3B05C3B374BD2941603F72D3F9A62EAB9A2FDAEEEEC8EE6E350F8A1863C0A0AB1B4058D154559A1CD5133EFCF682ABC339960819C9427889D60380B635A7D21D017974BBA57798490F668ADD86DA58125D9C4C1202CA1308F7734E43E8F77CEB0AF968A8F8B88849F9B98B26620399470ED057E7931DED82876DCA896A30D0031A8CBD7B9EDFDF16C15C6853F4F8D9EEC09317C84EDAE4B349FE54D23D8EC7DC9BB9F69FD7B7B23383B64F22E25F",
        binaryImageFormat: 2,
        bestQualityFingers: [1, 2],
    };
    const map = {
        "1": "id",
        "2": "version",
        "3": "language",
        "4": "fullName",
        "5": "firstName",
        "6": "middleName",
        "7": "lastName",
        "8": "dob",
        "9": "gender",
        "10": "address",
        "11": "email",
        "12": "phone",
        "13": "nationality",
        "14": "maritalStatus",
        "15": "guardian",
        "16": "binaryImage",
        "17": "binaryImageFormat",
        "18": "bestQualityFingers",
    };

    const data =
        "d18443a10104a1044c53796d6d65747269633235365903ebb2016e31313131303030303332343031330263312e300362454e046c5065746572204d204a686f6e0565506574657206614d07644a686f6e0868313938383031303209010a78184e657720436974792c204d4554524f204c494e452c2050410b717065746572406578616d706c652e636f6d0c6a2b31203233342d3536370d6255530e020f6a4a686f6e20486f6e61691079035130334342414244463833443036384143423544453635423343444632354530303336463243353436434239303337384335383741303736453741373539444644323743413738373242364344464633333941454141434136314136303233464431443330354139423446333343414132343843454445333842363744374339313543353941353142423445373744313030373741363235323538383733313833463832443635463443343832353033413541303146343144454536313243333534324535333730393837383135453539324238454132303230464433424444433734373839374442313032333745414431373945353542343431424336443842414430374345353335313239434638443535393434354343334132394437343646424631313734444532453743304633343339424537444245413435323043463838383235414145364231463239314137343641423831373743363542324134353944443139424433324330433330373030303442383543314436333033343730374343363930414230424130323333353043383333374643363839343036314542384137313441384632324645323336354537413930344337324445433937343641424541314133323936454341434431413430343530373934454443443242333438343445374331394542374642314134414633423035433342333734424432393431363033463732443346394136324541423941324644414545454543384545364533353046384131383633433041304142314234303538443135343535394131434435313333454643463638324142433333393936303831394339343237383839443630333830423633354137443231443031373937344242413537373938343930463636384144443836444135383132354439433443313230324341313330384637373334453433453846373743454230414639363841384638423838383439463942393842323636323033393934373045443035374537393331444544383238373644434138393641333044303033314138434244374239454446444631364331354336383533463446384439454543303933313743383445444145344233343946453534443233443845433744433942423946363946443742374232333338334236344632324532354611021282010248a8b933c56fa9d33d";

    const actual = await decodeCWT(data, map, decKey);
    expect(actual).toStrictEqual(expected);
});
